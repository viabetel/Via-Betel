generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Lead do aluno solicitando orçamento (sem contato direto com instrutor)
model Lead {
  id               String           @id @default(cuid())
  city             String
  neighborhood     String?
  category         String          // CNH desejada
  availability1    String          // opção 1
  availability2    String?         // opção 2
  availability3    String?         // opção 3
  objective        String?         // baliza, medo, prova, etc
  notes            String?
  studentName      String?         // opcional
  studentWhatsApp  String?         // opcional (nunca exposto ao instrutor)
  status           LeadStatus      @default(PENDING)
  createdAt        DateTime        @default(now())
  
  @@map("leads")
}

// Regras:
// - Instrutores sem plano ativo podem responder até 7 alunos diferentes por mês
// - O contador reseta no início de cada mês (baseado em year + month)
// - Conversas já iniciadas no mês atual não contam novamente
model MonthlyChatUsage {
  id                String   @id @default(cuid())
  
  // Instrutor que está usando
  userId            String
  
  // Período: ano e mês para reset automático
  year              Int
  month             Int
  
  // Quantas conversas distintas o instrutor respondeu neste mês
  usedConversations Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, year, month])
  @@index([userId])
  @@map("monthly_chat_usage")
}

// Evita contar a mesma conversa múltiplas vezes no mesmo mês
model ConversationUsageLog {
  id              String   @id @default(cuid())
  
  userId          String      // instrutor
  conversationId  String      // ID da conversa
  year            Int
  month           Int
  
  // Quando o instrutor respondeu pela primeira vez nesta conversa neste mês
  firstReplyAt    DateTime @default(now())

  @@unique([userId, conversationId, year, month])
  @@index([userId, year, month])
  @@map("conversation_usage_logs")
}

model Profile {
  id                      String                @id @default(cuid())
  email                   String                @unique
  fullName                String?
  phone                   String?
  city                    String?
  bio                     String?
  avatar                  String?
  created_at              DateTime              @default(now())
  updated_at              DateTime              @updatedAt
  
  // Role e status
  role                    String                @default("STUDENT") // STUDENT | INSTRUCTOR | ADMIN
  instructor_status       String                @default("NONE") // NONE | STARTED | PROFILE_DONE | UNDER_REVIEW | VERIFIED | REJECTED
  instructor_rejection_reason String?
  banned_at               DateTime?
  
  // Relações
  instructorProfile       InstructorProfile?
  documents               Document[]
  
  @@map("profiles")
}

model InstructorProfile {
  id                String            @id @default(cuid())
  profileId         String            @unique
  profile           Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Campos do instrutor
  categories        String[]          @default([])
  bio               String?
  priceHour         Float?
  serviceAreas      Json?
  availabilityJson  Json?
  experience_years  Int               @default(0)
  specialties       String[]          @default([])
  isPublic          Boolean           @default(false)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@map("instructor_profiles")
}

model Document {
  id                String            @id @default(cuid())
  profileId         String
  profile           Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  documentType      String            // ID, CERTIFICATE, BACKGROUND_CHECK
  storagePath       String            @unique
  status            String            @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewNotes       String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([profileId])
  @@index([status])
  @@map("documents")
}

model Request {
  id              String          @id @default(cuid())
  studentId       String
  instructorId    String?         // null = pedido aberto
  title           String
  description     String
  category        String
  city            String
  preferredDates  String?         // JSON array
  budget          Int?            // em centavos
  status          RequestStatus   @default(NEW)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  events          RequestEvent[]
  conversation    Conversation?

  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@map("requests")
}

enum RequestStatus {
  NEW
  VIEWED
  RESPONDED
  AGREED
  COMPLETED
  CANCELED
  EXPIRED
}

model RequestEvent {
  id          String    @id @default(cuid())
  requestId   String
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  type        String    // ex: "created", "viewed", "responded", "agreed", "completed"
  description String?
  createdAt   DateTime  @default(now())

  @@index([requestId])
  @@map("request_events")
}

model Conversation {
  id          String      @id @default(cuid())
  requestId   String      @unique
  request     Request     @relation(fields: [requestId], references: [id], onDelete: Cascade)
  studentId   String
  instructorId String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  messages    Message[]

  @@index([requestId])
  @@index([studentId])
  @@index([instructorId])
  @@map("conversations")
}

model Message {
  id              String      @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId        String
  content         String?     // null se for arquivo
  fileUrl         String?     // URL do arquivo em storage
  fileType        String?     // "file" ou "image"
  fileName        String?
  createdAt       DateTime    @default(now())

  reads           MessageRead[]

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

model MessageRead {
  id          String    @id @default(cuid())
  messageId   String
  message     Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId      String
  readAt      DateTime  @default(now())

  @@unique([messageId, userId])
  @@map("message_reads")
}

model AuditLog {
  id          String    @id @default(cuid())
  action      String    // ex: "request_created", "message_sent"
  userId      String
  entityType  String    // ex: "Request", "Message"
  entityId    String
  details     Json?     // detalhes da ação
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([entityType])
  @@map("audit_logs")
}

enum LeadStatus {
  PENDING
  CONTACTED
  CLOSED
}
